'use strict';

var usersDao = require('../../dao/users');

var authenticateRequest = function(req,callbk){
	
	var productId = req.query.product_id?req.query.product_id:req.body.product_id;
	var accessToken = req.query.access_token?req.query.access_token:req.body.access_token;
	
	var error;
	
	if(!productId || productId.trim() == ''){
		callbk("Missing product key");
	} else if(!accessToken || accessToken.trim() == ''){
		callbk("Missing access token");
	} else{
		//get entry from access table
		//if missing, authentication failed
		usersDao.getAccessTokenDetails(accessToken, productId,function(err, data){
			if(!data || data.length == 0){
				callbk("Authentication failed");
			} else{
				var userId = data[0].user_id;
				req.user_id = userId;
                req.access_token = accessToken;
                req.product_id = productId;
				callbk();
			}
			
		});
	}
	
}

module.exports = function () {
    return function (req, res, next) {
        console.log('in security interceptor');
        if(req.url.indexOf('getNewAccesToken') != -1){
            next();   
        } else{
            authenticateRequest(req,function(err){
                if(err){
                    res.json({error: err});
                } else{
                 next();   
                }
            });    
        }
    };
};